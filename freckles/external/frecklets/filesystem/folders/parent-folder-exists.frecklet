doc:
  short_help: Ensures the parent folder of a path exists.
  help: |
    Ensures the parent folder of a path exists. If the ``owner`` and/or ``group`` variables is/are specified, those will be created if they don't exist yet
    and set alongside the mode for that folder.

    If the parent folder already exists, nothing will be done (no user/group created), and that folders owner, group and permissions will be left untouched.

args:
  path:
    doc:
      short_help: The path to the child file/folder.
    type: string
    required: true
    cli:
      param_type: argument
  owner:
    doc:
      short_help: The owner of the folder, will be created if necessary.
    type: string
    required: false
    cli:
      metavar: USER_NAME
  group:
    doc:
      short_help: The group of the folder, will be created if necessary.
    type: string
    required: false
    cli:
      metavar: GROUP_NAME
  mode:
    doc:
      short_help: The permissions of the folder.
    type: string
    required: false
    cli:
      metavar: MODE
  become:
    doc:
      short_help: Whether to use root privileges to create the folder.
    type: boolean
    default: false
    required: false
    cli:
      is_flag: true

meta:
  is_interface: true
  tags:
    - file
    - filesystem
    - folder
    - mkdir
    - featured-frecklecutable

frecklets:
  - frecklet:
      command: stat
      type: ansible-module
      __msg__: "[checking if parent folder exists]"
      become: "{{:: become ::}}"
      register: "__parent_folder__"
    vars:
      path: "{{:: path | dirname ::}}"
  - group-exists:
      frecklet.__skip__: "__parent_folder__.stat.exists"
      group: "{{:: group ::}}"
  - user-exists:
      frecklet.__skip__: "__parent_folder__.stat.exists"
      name: "{{:: owner ::}}"
  - frecklet:
      command: file
      type: ansible-module
      __msg__: "[creating directory: {{:: path | dirname ::}}']"
      become: "{{ 'yes' if {{:: become ::}} or ansible_user != '{{:: owner ::}}' else 'no' }}"
      when: "not __parent_folder__.stat.exists"
    vars:
      path: "{{:: path | dirname ::}}"
      owner: "{{:: owner | default(omit) ::}}"
      group: "{{:: group | default(omit) ::}}"
      mode: "{{:: mode | default(omit) ::}}"
      recurse: true
      state: directory
