doc:
  short_help: Ensures a user exists on a system.
  help: |
    Ensure a user exists on a system.

    If no ``password`` or ``password_plain`` argument is provided, the created user won't be able do login via ssh via
    password auth, and they won't be able to do sudo if passwordless sudo is not enabled for the user.

    This task allows for providing the password either as [pre-encrypted string](https://docs.ansible.com/ansible/latest/reference_appendices/faq.html#how-do-i-generate-crypted-passwords-for-the-user-module), or in plain text. It is strongly recommended to use the 'pre-encrypt' variable
    (``password``) over the plain text one (``password_plain``). If both are provided, ``password`` takes precedence.

    Optionally, you can specify UID, main group and GID of the user.
    If the ``group`` var is specified, a corresponding group will be created if it doesn't exist yet.

  further_reading:
    - "[Underlying Ansible module doc for 'group' creation](https://docs.ansible.com/ansible/latest/modules/group_module.html)"
    - "[Underlying Ansible module doc for 'user' creation](https://docs.ansible.com/ansible/latest/modules/user_module.html)"

args:
  name:
    doc:
      short_help: The name of the user to create.
    type: string
    required: true
    cli:
      metavar: USER_NAME
      param_type: argument
  uid:
    doc:
      short_help: The uid of the user to create (optional).
    type: integer
    required: false
    cli:
      metavar: UID
  group:
    doc:
      short_help: The name of the users main group.
    type: string
    required: false
    cli:
      metavar: GROUP_NAME
  gid:
    doc:
      short_help: The GID of the users main group (optional).
    type: integer
    required: false
    cli:
      metavar: GID
  system_user:
    doc:
      short_help: whether the user to create should be created as system user
    type: boolean
    required: false
    cli:
      show_default: true
      is_flag: true
  password:
    doc:
      short_help: "The crypted user password."
      help: |
        This sets the users password. If not provided, the user won't be able to login via password auth, and can't do
        sudo if passwordless sudo is not configured.
      further_reading:
        - "[password encryption](https://docs.ansible.com/ansible/latest/modules/user_module.html)"
    type: password
    required: false
    cli:
      metavar: PWD
  password_plain:
    doc:
      short_help: "The user password in plain text."
      help: |
        This sets the users password in plain text. The user input will be sha512-hashed before forwareded to the connector.
        It is strongly recommended to use the ``password`` argument in favor of this.

        If not provided, the user won't be able to login via password auth, and can't do
        sudo if passwordless sudo is not configured.
    type: password
    coerce: sha512_crypt
    required: false
    cli:
      metavar: PWD
  shell:
    doc:
      short_help: "The users default shell."
    type: string
    required: false
    default: "/bin/bash"

meta:
  tags:
    - user
    - user-management
    - system

frecklets:
  - group-exists:
      group: "{{:: group ::}}"
      gid: "{{:: gid | default(omit) ::}}"
      system: "{{:: system_user | default(omit) ::}}"
      frecklet.__skip__: "{{:: group | true_if_empty ::}}"
  - user-exists-impl:
      name: "{{:: name ::}}"
      uid: "{{:: uid | default(omit) ::}}"
      group: "{{:: group | default(omit) ::}}"
      system: "{{:: system_user | default(omit) ::}}"
      password: "{{:: password | default(omit) ::}}"
      password_plain: "{{:: password_plain | default(omit) ::}}"
      shell: "{{:: shell | default(omit) ::}}"
